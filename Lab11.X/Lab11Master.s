; LAB 11
; Jacob Horsley
; RCET 3375
; Fifth Semester
; I2C Communication (Master)
; Git URL: https://github.com/horsjaco117/Assembly_Code
    
; Device Setup
;--------------------------------------------------------------------------
; Configuration
    ; CONFIG1
  CONFIG FOSC = XT
  CONFIG WDTE = OFF
  CONFIG PWRTE = OFF
  CONFIG MCLRE = ON
  CONFIG CP = OFF
  CONFIG CPD = OFF
  CONFIG BOREN = OFF
  CONFIG IESO = OFF
  CONFIG FCMEN = OFF
  CONFIG LVP = OFF
; CONFIG2
  CONFIG BOR4V = BOR40V
  CONFIG WRT = OFF
; Include Statements
#include <xc.inc>
; Code Section
;--------------------------------------------------------------------------
 
; Register/Variable Setup
  SOMEVALUE EQU 0x5f
;---------------------------------------------------------------------
; Reset & Interrupt vectors
;---------------------------------------------------------------------
PSECT resetVect, class=CODE, delta=2
    GOTO Start
PSECT isrVect, class=CODE, delta=2
    GOTO INTERRUPT
Start:
Setup:
; Bank 3
    BSF STATUS, 5
    BSF STATUS, 6
    MOVLW 0x17 ; AN0, AN1, AN2, AN4 analog (bits 0,1,2,4)
    MOVWF ANSEL
    CLRF ANSELH
    CLRF INTCON
    CLRF OPTION_REG
; Bank 2
    BCF STATUS, 5
    CLRF CM2CON1
; Bank 1
    BSF STATUS, 5
    BCF STATUS, 6
    MOVLW 0xFF
    MOVWF WPUB
    CLRF IOCB
    CLRF PSTRCON
    MOVLW 0x18
    MOVWF TRISC
    MOVLW 0x42
    MOVWF PIE1
    MOVLW 0x00
    MOVWF PIE2
    CLRF SSPCON2
    CLRF SSPSTAT
    MOVLW 0x09
    MOVWF SSPADD
    MOVLW 0x0F
    MOVWF TRISB
    MOVLW 0XC5
    MOVWF ADCON1
; Bank 0
    BCF STATUS, 5
    BCF STATUS, 6
    CLRF CCP1CON
    CLRF PORTC
    CLRF CCP2CON
    CLRF PORTB
    CLRF RCSTA
    CLRF T1CON
    CLRF INTCON
    CLRF PIR1
    CLRF PIR2
    MOVLW 0x28
    MOVWF SSPCON
    BANKSEL ADCON0
    MOVLW 0x01
    MOVWF ADCON0
    BANKSEL ADCON1
    BCF ADCON1, 7
    BANKSEL CHANNEL_TABLE
    MOVLW 0x00 ; AN0 (new channel 0)
    MOVWF CHANNEL_TABLE
    MOVLW 0x04 ; AN4 (channel 1)
    MOVWF CHANNEL_TABLE+1
    MOVLW 0x01 ; AN1 (channel 2)
    MOVWF CHANNEL_TABLE+2
    MOVLW 0x02 ; AN2 (channel 3)
    MOVWF CHANNEL_TABLE+3
    ; ID table for servo IDs (0: servo4 ID=00, 1: servo1 ID=11, 2: servo2 ID=01, 3: servo3 ID=10)
    MOVLW 0x00
    MOVWF ID_TABLE
    MOVLW 0x03
    MOVWF ID_TABLE+1
    MOVLW 0x01
    MOVWF ID_TABLE+2
    MOVLW 0x02
    MOVWF ID_TABLE+3
   
; Register/Variable setups
     COUNT1 EQU 0x20
     COUNT2 EQU 0x21
     COUNT3 EQU 0x22
     COUNT4 EQU 0X23
     COUNT5 EQU 0X24
     COUNT6 EQU 0X25
     COUNT7 EQU 0X26
     W_TEMP EQU 0X2B
     STATUS_TEMP EQU 0X2C
     TEMP EQU 0x2D
     CURRENT_INDEX EQU 0x2E
     DATA_TO_SEND EQU 0x2F
     CHANNEL_TABLE EQU 0x30
     ID_TABLE EQU 0x34
; Main Program Loop
MAINLOOP:
    MOVLW CHANNEL_TABLE
    ADDWF CURRENT_INDEX, W
    MOVWF FSR
    MOVF INDF, W
    BANKSEL ADCON0
    MOVWF TEMP
    RLF TEMP, F
    RLF TEMP, W
    MOVWF TEMP
    MOVF ADCON0, W
    ANDLW 0xC3
    IORWF TEMP, W
    MOVWF ADCON0
START_CONV:
    BSF ADCON0, 1
    BANKSEL PIR1
    BTFSS PIR1, 6
    GOTO $-1
    BCF PIR1, 6
    BANKSEL ADRESH
    MOVF ADRESH, W
    MOVWF DATA_TO_SEND
   
    ; Embed ID from table
    MOVLW ID_TABLE
    ADDWF CURRENT_INDEX, W
    MOVWF FSR
    MOVF INDF, W
    MOVWF TEMP
    MOVF DATA_TO_SEND, W
    ANDLW 0xFC
    IORWF TEMP, W
    MOVWF DATA_TO_SEND

HIGH0:
    MOVLW 0X01
    MOVWF COUNT3
FINALLOOP0:
    MOVLW 0X01
    MOVWF COUNT2
OUTERLOOP0:
    MOVLW 0X01
    MOVWF COUNT1
INNERLOOP0:
    DECFSZ COUNT1
    GOTO INNERLOOP0
    DECFSZ COUNT2
    GOTO OUTERLOOP0
    DECFSZ COUNT3
    GOTO FINALLOOP0
 
    CALL Delay1
    GOTO LOW0
 
LOW0:
    MOVLW 0X01
    MOVWF COUNT6
FINALLOOP1:
    MOVLW 0X01
    MOVWF COUNT5
OUTERLOOP1:
    MOVLW 0X01
    MOVWF COUNT4
INNERLOOP1:
    DECFSZ COUNT4
    GOTO INNERLOOP1
    DECFSZ COUNT5
    GOTO OUTERLOOP1
    DECFSZ COUNT6
    GOTO FINALLOOP1
 
    CALL Delay2
    CALL I2C_SEND
 
    INCF CURRENT_INDEX, F
    MOVF CURRENT_INDEX, W
    SUBLW 0x03
    BTFSS STATUS, 0
    CLRF CURRENT_INDEX
    GOTO MAINLOOP
 
; Delay Subroutines
Delay1:
    MOVLW 0X10
    MOVWF COUNT7
LOOPA:
    DECFSZ COUNT7
    GOTO LOOPA
    NOP
    NOP
    RETURN
Delay2:
    MOVLW 0X10
    MOVWF COUNT7
LOOPB:
    DECFSZ COUNT7
    GOTO LOOPB
    NOP
    NOP
    RETURN
 
; Sends I2C
I2C_SEND:
    BSF STATUS, 5
    BCF STATUS, 6
    BTFSC SSPSTAT, 2
    GOTO $-1
    BSF SSPCON2, 0
    BTFSC SSPCON2, 0
    GOTO $-1
   
    BCF STATUS, 5
    BCF STATUS, 6
    MOVLW 0x40
    MOVWF SSPBUF
    BTFSS PIR1, 3
    GOTO $-1
    BCF PIR1, 3
   
    BSF STATUS, 5
    BCF STATUS, 6
    BTFSC SSPCON2, 6
    GOTO ERROR1
   
    BCF STATUS, 5
    BCF STATUS, 6
    MOVLW 0x24
    MOVWF SSPBUF
    BTFSS PIR1, 3
    GOTO $-1
    BCF PIR1, 3
   
    BSF STATUS, 5
    BCF STATUS, 6
    BTFSC SSPCON2, 6
    GOTO ERROR1
   
    BCF STATUS, 5
    BCF STATUS, 6
    MOVF DATA_TO_SEND, W
    MOVWF SSPBUF
    BTFSS PIR1, 3
    GOTO $-1
    BCF PIR1, 3
   
    BSF STATUS, 5
    BCF STATUS, 6
    BTFSC SSPCON2, 6
    GOTO ERROR1
   
    BSF SSPCON2, 2
    BTFSC SSPCON2, 2
    GOTO $-1
   
    BCF STATUS, 5
    BCF STATUS, 6
    RETURN
ERROR1:
    BCF STATUS, 5
    BCF STATUS, 6
    BCF SSPCON, 5
    BSF SSPCON, 5
    RETURN
INTERRUPT:
    RETFIE
END
